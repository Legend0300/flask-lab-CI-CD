name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  test-build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install flask pytest; fi

      - name: Run unit tests
        run: pytest -q

      - name: Build Docker image
        run: docker build -t flask-lab-app:latest .

      - name: Set up Docker Compose
        uses: docker/compose-action@v2
        with:
          yaml: docker-compose.yml

      - name: Start services with docker compose
        run: docker compose up -d --build

      - name: Wait for app to be healthy
        run: |
          for i in $(seq 1 20); do
            if curl --silent --fail http://localhost:5000/health; then
              echo "Service is up"
              exit 0
            fi
            echo "Waiting for service..."
            sleep 2
          done
          echo "Service did not start" >&2
          exit 1

      - name: Run smoke tests against running service
        run: |
          curl -f http://localhost:5000/health
          curl -f http://localhost:5000/data

      - name: Teardown compose
        if: always()
        run: docker compose down --volumes --remove-orphans